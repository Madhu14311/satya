<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grocery Expiry Tracker — Working Version</title>

<link rel="stylesheet"
href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
body {
  font-family: Inter, system-ui, Arial;
  background: #beefc2;
  padding: 20px;
}

.wrap { max-width: 1100px; margin: auto; }

.grid {
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 16px;
}
@media(max-width:900px) {
  .grid { grid-template-columns: 1fr; }
}

.card {
  background: #fff;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 16px;
}

input, select {
  width: 95%;
  padding: 8px;
  margin-top: 6px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  padding: 8px 12px;
  border-radius: 8px;
  border: 0;
  cursor: pointer;
}

.btn-primary { background: #2463eb; color: white; }
.btn-ghost { background: #f1f5f9; }

.item {
  background: white;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
}
.expired { background: #ffcccc; }
.near-expiry { background: #fff3cd; }

video, #capture-canvas {
  width: 250px;
  height: 180px;
  border-radius: 8px;
  border: 1px solid #444;
  margin-top: 6px;
}
</style>
</head>
<body>

<div class="wrap">
  <h2>Grocery Expiry Tracker</h2>

  <div class="grid">
  
    <!-- LEFT SIDE -->
    <div class="card">
      <h3>Item Form</h3>

      <label>Name</label>
      <input id="name">

      <label>Brand</label>
      <input id="brand">

      <label>Quantity</label>
      <input id="qty">

      <label>Category</label>
      <select id="category">
        <option>Grocery</option>
        <option>Dairy</option>
        <option>Snacks</option>
        <option>Beverage</option>
        <option>Household</option>
        <option>Other</option>
      </select>

      <label>Purchase Date</label>
      <input id="purchase" type="date">

      <label>Expiry Date</label>
      <input id="expiry" type="date">

      <label>Shelf Life</label>
      <input id="shelf" type="number">

      <label>Barcode</label>
      <input id="barcode">

      <br><br>
      <button id="save-item" class="btn-primary">Save Item (QR)</button>
      <button id="generate-qr" class="btn-ghost">Generate QR</button>
      <button id="clear-form" class="btn-ghost">Clear</button>

      <br><br>
      <canvas id="qr-code" width="240" height="240"></canvas>

      <h3>Saved Items</h3>
      <div id="items-list"></div>

    </div>

    <!-- RIGHT SIDE -->
    <div class="card">
      <h3>QR Scanner</h3>

      <video id="video" autoplay muted></video>
      <canvas id="capture-canvas" width="250" height="180" style="display:none"></canvas>

      <br>
      <button id="start-scan" class="btn-primary">Start Scanner</button>
      <button id="stop-scan" class="btn-ghost">Stop Scanner</button>

      <p id="scan-status" style="margin-top:10px;font-weight:bold"></p>
      <p><b>QR Raw:</b> <span id="qr-raw"></span></p>

    </div>

  </div>

</div>

<script>
setInterval(()=>{ document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);


const video = document.getElementById("video");
const canvas = document.getElementById("capture-canvas");
const ctx = canvas.getContext("2d");

const qrCanvas = document.getElementById("qr-code");
const qr = new QRious({ element: qrCanvas, size: 240 });

let stream = null;
let scanning = false;
let items = JSON.parse(localStorage.getItem("items") || "[]");
let editIndex = -1;

function readForm() {
  return {
    name: name.value,
    brand: brand.value,
    qty: qty.value,
    category: category.value,
    purchase: purchase.value,
    expiry: expiry.value,
    shelf: shelf.value,
    barcode: barcode.value
  };
}

function populateForm(item, index) {
  name.value = item.name;
  brand.value = item.brand;
  qty.value = item.qty;
  category.value = item.category;
  purchase.value = item.purchase;
  expiry.value = item.expiry;
  shelf.value = item.shelf;
  barcode.value = item.barcode;
  editIndex = index;
}

function renderItems() {
  const list = document.getElementById("items-list");
  list.innerHTML = "";

  const today = new Date();

  items.forEach((item, index) => {
    const div = document.createElement("div");

    let expiryDate = new Date(item.expiry);

    div.classList.add("item");
    if (expiryDate < today) div.classList.add("expired");
    else if ((expiryDate - today) / (1000*60*60*24) <= 3)
      div.classList.add("near-expiry");

    div.innerHTML = `
      <div>${item.name} (${item.category}) — Exp: ${item.expiry}</div>
      <div>
        <button onclick="editItem(${index})">Edit</button>
        <button onclick="deleteItem(${index})">Delete</button>
      </div>
    `;
    list.appendChild(div);
  });

  localStorage.setItem("items", JSON.stringify(items));
}

document.getElementById("save-item").onclick = () => {
  const data = readForm();

  if (!data.name || !data.brand || !data.qty || !data.expiry) {
    alert("Name, Brand, Quantity, and Expiry are required!");
    return;
  }

  if (editIndex >= 0) {
    items[editIndex] = data;
    editIndex = -1;
  } else {
    items.push(data);
  }

  qr.value = JSON.stringify(data);
  renderItems();
};

document.getElementById("generate-qr").onclick = () => {
  qr.value = JSON.stringify(readForm());
};

document.getElementById("clear-form").onclick = () => {
  name.value = brand.value = qty.value = purchase.value =
  expiry.value = shelf.value = barcode.value = "";
  category.value = "Grocery";
  qr.value = "";
};

function editItem(index) {
  populateForm(items[index], index);
}

function deleteItem(index) {
  items.splice(index, 1);
  renderItems();
}

async function startScanner() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = stream;
    scanning = true;
    document.getElementById("scan-status").innerText = "Scanner Running...";
    scanLoop();

  } catch (e) {
    alert("Camera blocked or not available");
  }
}

function stopScanner() {
  scanning = false;
  if (stream) stream.getTracks().forEach(t => t.stop());
  video.srcObject = null;
  document.getElementById("scan-status").innerText = "Scanner Stopped";
}

function scanLoop() {
  if (!scanning) return;

  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    let img = ctx.getImageData(0, 0, canvas.width, canvas.height);

    const code = jsQR(img.data, img.width, img.height);

    if (code) {
      document.getElementById("qr-raw").innerText = code.data;

      try {
        let obj = JSON.parse(code.data);
        Object.keys(obj).forEach(k => {
          if (document.getElementById(k)) {
            document.getElementById(k).value = obj[k];
          }
        });
        document.getElementById("scan-status").innerText = "Form filled!";
      } catch {
        document.getElementById("scan-status").innerText = "Invalid JSON";
      }
    }
  }

  requestAnimationFrame(scanLoop);
}

document.getElementById("start-scan").onclick = startScanner;
document.getElementById("stop-scan").onclick = stopScanner;

renderItems();

</script>
</body>
</html>
